{% extends "base.html" %}

{% block page_title %}Paiements - {{ student.full_name }}{% endblock %}

{% block content %}
<div class="row mb-5 g-4 animate-in">
  <div class="col-12">
    <div class="card border-0 shadow-premium p-4 bg-dark text-white overflow-hidden position-relative">
      <div class="position-absolute top-0 end-0 p-5 opacity-10">
        <i data-lucide="wallet" style="width: 150px; height: 150px;"></i>
      </div>
      <div class="d-flex flex-wrap justify-content-between align-items-center position-relative">
        <div class="d-flex align-items-center gap-4">
          <a href="/students/{{ student.id }}" class="btn btn-outline-light rounded-circle p-2 shadow-sm"
            style="width: 42px; height: 42px;">
            <i data-lucide="arrow-left" style="width: 20px;"></i>
          </a>
          <div>
            <h3 class="fw-extrabold mb-1">Dossier Financier</h3>
            <p class="opacity-75 mb-0">Gestion des règlements pour <b>{{ student.full_name }}</b></p>
          </div>
        </div>
        <div class="mt-3 mt-md-0">
          <a class="btn btn-primary rounded-pill px-4 py-3 fw-bold shadow-sm d-flex align-items-center gap-2"
            href="/payments/student/{{ student.id }}/new">
            <i data-lucide="plus-circle" style="width: 20px;"></i>
            Encaisser un paiement
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mb-5 animate-in" style="animation-delay: 0.1s;">
  <div class="col-12 col-md-4">
    <div class="card border-0 shadow-premium p-4 h-100 bg-white">
      <div class="d-flex align-items-center gap-3 mb-3">
        <div class="bg-primary-soft p-2 rounded-3 text-primary">
          <i data-lucide="file-text" style="width: 20px;"></i>
        </div>
        <label class="smaller text-uppercase fw-bold letter-spacing-1 text-muted">Contrat Global</label>
      </div>
      <div class="h2 fw-extrabold mb-0 text-dark">{{ "{:,.0f}".format(total_amount).replace(',', ' ') }} <span
          class="h6 text-muted fw-normal">{{ student.currency }}</span></div>
      <div class="progress mt-3 rounded-pill bg-light" style="height: 6px;">
        <div class="progress-bar bg-primary" style="width: 100%"></div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-4">
    <div class="card border-0 shadow-premium p-4 h-100 bg-white">
      <div class="d-flex align-items-center gap-3 mb-3">
        <div class="bg-success-soft p-2 rounded-3 text-success">
          <i data-lucide="check-circle" style="width: 20px;"></i>
        </div>
        <label class="smaller text-uppercase fw-bold letter-spacing-1 text-muted">Total Encaissé</label>
      </div>
      <div class="h2 fw-extrabold mb-0 text-success">{{ "{:,.0f}".format(paid).replace(',', ' ') }} <span
          class="h6 text-muted fw-normal">{{ student.currency }}</span></div>
      <div class="progress mt-3 rounded-pill bg-light" style="height: 6px;">
        {% set progress = (paid / total_amount * 100) if total_amount > 0 else 0 %}
        <div class="progress-bar bg-success" style="width: {{ progress }}%"></div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-4">
    <div class="card border-0 shadow-premium p-4 h-100 bg-white">
      <div class="d-flex align-items-center gap-3 mb-3">
        <div
          class="{% if balance > 0 %}bg-danger-soft text-danger{% else %}bg-info-soft text-info{% endif %} p-2 rounded-3">
          <i data-lucide="alert-circle" style="width: 20px;"></i>
        </div>
        <label class="smaller text-uppercase fw-bold letter-spacing-1 text-muted">Solde Restant</label>
      </div>
      <div class="h2 fw-extrabold mb-0 {% if balance > 0 %}text-danger{% else %}text-info{% endif %}">{{
        "{:,.0f}".format(balance).replace(',', ' ') }} <span class="h6 text-muted fw-normal">{{ student.currency
          }}</span></div>
      <div class="mt-3 smaller {% if balance > 0 %}text-danger{% else %}text-info{% endif %} fw-bold">
        {% if balance > 0 %}Règlement partiel{% else %}Contrat soldé{% endif %}
      </div>
    </div>
  </div>
</div>

<div class="card border-0 shadow-premium overflow-hidden animate-in" style="animation-delay: 0.2s;">
  <div class="card-header bg-white border-0 p-4 d-flex justify-content-between align-items-center">
    <h5 class="fw-bold mb-0">Détails des Recettes</h5>
    <div class="bg-light px-3 py-1 rounded-pill extra-small fw-bold text-muted">{{ payments|length }} transaction(s)
    </div>
  </div>
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead>
        <tr class="bg-light-soft">
          <th class="ps-4 py-3 text-muted extra-small text-uppercase fw-bold letter-spacing-1">Référence & Date</th>
          <th class="py-3 text-muted extra-small text-uppercase fw-bold letter-spacing-1">Motif</th>
          <th class="py-3 text-muted extra-small text-uppercase fw-bold letter-spacing-1 text-center">Montant</th>
          <th class="py-3 text-muted extra-small text-uppercase fw-bold letter-spacing-1">Mode & Statut</th>
          <th class="pe-4 py-3 text-end">Justificatif</th>
        </tr>
      </thead>
      <tbody>
        {% for p in payments %}
        <tr class="transition-all">
          <td class="ps-4 py-4">
            <div class="fw-bold text-dark mb-1">#REC-{{ p.id }}</div>
            <div class="extra-small text-muted d-flex align-items-center gap-1">
              <i data-lucide="calendar" style="width: 12px;"></i> {{ p.payment_date }}
            </div>
          </td>
          <td class="py-4 fw-bold text-dark">{{ p.payment_type }}</td>
          <td class="py-4 text-center">
            <div class="h6 fw-extrabold text-primary mb-0">{{ "{:,.0f}".format(p.amount).replace(',', ' ') }}</div>
            <div class="extra-small text-muted">{{ p.currency }}</div>
          </td>
          <td class="py-4">
            <div class="badge bg-light text-dark fw-bold border-0 px-3 py-2 mb-2" style="font-size: 0.65rem;">{{
              p.payment_mode }}</div>
            <br>
            {% if p.payment_status == 'received' %}
            <div
              class="d-inline-flex align-items-center gap-1 p-1 px-2 rounded-pill bg-success-soft text-success extra-small fw-extrabold">
              <span class="status-dot-success"></span> CONFIRMÉ
            </div>
            {% elif p.payment_status == 'pending' %}
            <div
              class="d-inline-flex align-items-center gap-1 p-1 px-2 rounded-pill bg-warning-soft text-warning extra-small fw-extrabold">
              <span class="status-dot-warning"></span> EN ATTENTE
            </div>
            {% endif %}
          </td>
          <td class="pe-4 py-4 text-end">
            <div class="d-flex justify-content-end gap-2">
              {% if p.payment_status == 'pending' and role in ['admin', 'secretary'] %}
              <form action="/payments/confirm/{{ p.id }}" method="post"
                onsubmit="return confirm('Confirmer la réception de ce paiement ?')" class="d-inline">
                <button type="submit"
                  class="btn btn-sm btn-success rounded-pill px-3 fw-bold d-flex align-items-center gap-1 shadow-sm">
                  <i data-lucide="check" style="width: 14px;"></i> Confirmer
                </button>
              </form>
              {% endif %}

              {% if p.receipt_stored_path %}
              <a href="/payments/receipts/{{ p.id }}" class="btn-action bg-primary text-white"
                title="Télécharger le reçu">
                <i data-lucide="download" style="width: 18px;"></i>
              </a>
              {% else %}
              <span class="text-muted extra-small italic">Digital uniquement</span>
              {% endif %}
            </div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="5" class="text-center py-5">
            <div class="py-4">
              <i data-lucide="receipt" class="text-muted opacity-10 mb-3" style="width: 60px; height: 60px;"></i>
              <p class="text-muted">Aucune transaction pour ce dossier.</p>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<style>
  .fw-extrabold {
    font-weight: 800;
  }

  .letter-spacing-1 {
    letter-spacing: 1.2px;
  }

  .extra-small {
    font-size: 0.65rem;
  }

  .bg-light-soft {
    background-color: #fbfcfd;
  }

  .btn-action {
    width: 38px;
    height: 38px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    border: none;
    transition: all 0.2s;
  }

  .btn-action:hover {
    transform: scale(1.1);
    box-shadow: var(--shadow-md);
  }

  .status-dot-success {
    width: 6px;
    height: 6px;
    background: #10b981;
    border-radius: 50%;
  }

  .status-dot-warning {
    width: 6px;
    height: 6px;
    background: #f59e0b;
    border-radius: 50%;
  }

  .italic {
    font-style: italic;
  }
</style>
{% endblock %}
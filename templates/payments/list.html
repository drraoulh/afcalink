{% extends "base.html" %}

{% block page_title %}Journal des Paiements{% endblock %}

{% block content %}
<div class="row mb-4">
  <div class="col-12 d-flex justify-content-between align-items-center">
    <div>
      <h3 class="fw-bold mb-0">Transactions Globales</h3>
      <p class="text-muted smaller mb-0">Suivi complet des versements et de la comptabilité</p>
    </div>
  </div>
</div>

<div class="card shadow-sm border-0">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0 align-middle">
        <thead class="bg-light">
          <tr>
            <th class="ps-4 py-3 text-muted smaller text-uppercase fw-bold">Date</th>
            <th class="py-3 text-muted smaller text-uppercase fw-bold">Étudiant</th>
            <th class="py-3 text-muted smaller text-uppercase fw-bold">Type</th>
            <th class="py-3 text-muted smaller text-uppercase fw-bold">Montant</th>
            <th class="py-3 text-muted smaller text-uppercase fw-bold">Mode</th>
            <th class="py-3 text-muted smaller text-uppercase fw-bold">Statut</th>
            <th class="pe-4 py-3 text-end">Action</th>
          </tr>
        </thead>
        <tbody class="border-top-0">
          {% for p in payments %}
          <tr>
            <td class="ps-4 py-3 text-nowrap">
              <div class="fw-medium">{{ p.payment_date }}</div>
            </td>
            <td class="py-3">
              <div class="fw-bold text-dark">{{ p.student_name }}</div>
              <div class="text-muted smaller">ID Stud: #{{ p.student_id }}</div>
            </td>
            <td class="py-3">
              <span class="smaller fw-medium">{{ p.payment_type }}</span>
            </td>
            <td class="py-3">
              <div class="fw-bold text-primary">{{ "{:,.0f}".format(p.amount).replace(',', ' ') }} {{ p.currency }}
              </div>
            </td>
            <td class="py-3">
              <span class="badge bg-light text-dark fw-normal border">{{ p.payment_mode }}</span>
            </td>
            <td class="py-3">
              {% if p.payment_status == 'received' %}
              <span class="badge bg-success-soft text-success rounded-pill px-3">Reçu</span>
              {% elif p.payment_status == 'pending' %}
              <span class="badge bg-warning-soft text-warning rounded-pill px-3">En attente</span>
              {% else %}
              <span class="badge bg-secondary-soft text-secondary rounded-pill px-3">{{ p.payment_status }}</span>
              {% endif %}
            </td>
            <td class="pe-4 py-3 text-end">
              <div class="d-flex justify-content-end gap-2">
                {% if p.payment_status == 'pending' and role in ['admin', 'secretary'] %}
                <form action="/payments/confirm/{{ p.id }}" method="post"
                  onsubmit="return confirm('Confirmer ce paiement ?')" class="d-inline">
                  <button type="submit"
                    class="btn btn-xs btn-success rounded-pill px-2 py-1 extra-small fw-bold border-0 shadow-sm">
                    Confirmer
                  </button>
                </form>
                {% endif %}
                <a class="btn btn-light btn-sm rounded-circle d-inline-flex align-items-center justify-content-center"
                  style="width: 32px; height: 32px;" href="/payments/student/{{ p.student_id }}"
                  title="Fiche financière">
                  <i data-lucide="chevron-right" style="width: 16px;"></i>
                </a>
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="7" class="text-center py-5">
              <div class="py-4">
                <i data-lucide="banknote" class="mb-3 opacity-10" style="width: 48px; height: 48px;"></i>
                <p class="text-muted">Aucun paiement enregistré pour le moment.</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}